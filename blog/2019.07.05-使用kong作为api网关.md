# Kong

### 前言
目前我使用`kong`主要是由于以下几点
 - 作为api的统一入口，如果一个服务器部署了多个服务，只能部署到多个端口上，但443端口只有一个，大家都想用的话只能是搞一个api网关
 - 负载均衡，支持以后服务的性能扩展
 - 插件机制，目前看中了一个日志插件，应该是能够记录所有请求的，很方便

kong需要一个数据库，用来保存用户配置的数据，我们这边使用`PostgreSQL`。

### kong

kong对外提供了四个端口
 - 8000 : http的转发端口，作为网关使用，相当于nginx的80端口
 - 8443 : https的转发端口，作为网关使用，相当于nginx的443端口
 - 8001 : 管理端口(admin api)，提供restful api，也可以给那种图形化管理平台接入的
 - 8444 : 管理端口https的形式

### 部署 Kong 和 PostgreSQL

我们使用`docker-compose`部署kong服务

```
version: '2'
services:
  kong-database:
    image: postgres:latest
    container_name: kong-database
    environment:
      - POSTGRES_USER=kong
      - POSTGRES_DB=kong
      - POSTGRES_PASSWORD=kong
    ports:
      - 5432:5432

  kong:
    image: kong:latest 
    container_name: kong
    restart: always
    links:
      - kong-database:kong-database
    ports:
      - 8000:8000
      - 8443:8443
      - 8001:8001
      - 8444:8444
    environment:
      - KONG_DATABASE=postgres
      - KONG_PG_HOST=kong-database
      - KONG_PG_USER=kong
      - KONG_PG_DATABASE=kong
      - KONG_PG_PASSWORD=kong
      - KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl
```

以上是部署`kong`以及`postgres`服务的

第一步，执行

```
docker-compose up -d
```

会发现启动了两个容器，postgres正常启动，但是kong会一直在retry，说明发生了错误。原因是数据库需要初始化。

第二部，执行

```
docker-compose run kong kong migrations bootstrap
```

第三步，初始化成功后，再次执行

```
docker-compose up -d
```

就成功了，会有一个kong服务监听这8000，8001，8443，8444这四个端口。

注意：以上3步必须顺序执行才能成功，还不知道为什么。。。

此时，kong已经部署好了，那怎么使用呢？就轮到konga上场了。

# Konga

Konga是kong的图形化管理平台，没有konga的话只能以命令行的方式和kong交互。

启动konga

```
docker pull pantsel/konga
# 配置数据库
docker run --rm pantsel/konga:latest -c prepare -a postgres -u postgresql://kong:kong@{SERVER_IP}:5432/konga_database
# 启动
docker run -p 1337:1337 -d -e "TOKEN_SECRET=1113HU/12312312sss" -e "DB_ADAPTER=postgres" -e "DB_HOST=172.16.161.185" -e "DB_PORT=5432" -e "DB_USER=kong" -e "DB_PASSWORD=kong" -e "DB_DATABASE=konga_database" -e "NODE_ENV=production" --name konga pantsel/konga


docker run -p 1337:1337 --name konga -e "NODE_ENV=production" -e "TOKEN_SECRET=xxxxxxxxxxx" pantsel/konga
```

启动成功后，访问`localhost:1337`进入。注册登录操作后进入kong配置页面，在输入kong的admin api的时候注意不要填`127.0.0.1`或`localhost`，因为大家都在docker里面，要填局域网地址。

### 配置api转发接口

选中 services 菜单，点击`add new service`，这里填的是上游服务（upstream）的地址，代表了一个上游服务。

然后在`service detial`页面中选择`routers`，创建一个router，router表示的是当kong接收到什么样的请求时转发到你的service。

比如：service的配置如下：
```
Protocol: http
Host: 192.168.1.2
Port: 9090
Path: /
```

service的router配置如下：
```
Hosts: www.hqqsk8.com
paths: /test
protocal: ["http"]
```

那么转发的效果就是，当kong收到`http://www.hqqsk8.com/test/users`这个请求时，会转发到`http://192.168.1.2/users`这个地址。